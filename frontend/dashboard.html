<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | Attendance Monitoring System</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global Styles -->
  <link rel="stylesheet" href="css/global.css" />
  <link rel="stylesheet" href="css/dashboard.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* Enhanced Dashboard Styles */
    .sidebar {
      background: linear-gradient(180deg, #0c3b6a 0%, #08284a 100%);
    }

    .sidebar .logo {
      width: 120px;
      height: 120px;
      object-fit: contain;
      margin-bottom: 24px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg);
    }

    .sidebar .menu a {
      border-radius: 0;
      margin: 0;
      padding: 16px 24px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar .menu a:hover,
    .sidebar .menu a.active {
      background: linear-gradient(90deg, rgba(255, 204, 0, 0.2) 0%, transparent 100%);
      border-left: 4px solid #ffcc00;
    }

    .sidebar .menu a i {
      width: 20px;
      text-align: center;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .dashboard-header .greeting h2 {
      font-size: 28px;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 4px;
    }

    .dashboard-header .greeting p {
      color: var(--neutral-500);
      font-size: 14px;
    }

    .dashboard-header .date-badge {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--neutral-100);
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .stat-card.primary::before {
      background: var(--primary-600);
    }

    .stat-card.success::before {
      background: var(--accent-success);
    }

    .stat-card.warning::before {
      background: var(--accent-warning);
    }

    .stat-card.danger::before {
      background: var(--accent-danger);
    }

    .stat-card.info::before {
      background: var(--accent-info);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .stat-card.primary .stat-icon {
      background: #e0f2fe;
      color: var(--primary-600);
    }

    .stat-card.success .stat-icon {
      background: #dcfce7;
      color: var(--accent-success);
    }

    .stat-card.warning .stat-icon {
      background: #fef3c7;
      color: var(--accent-warning);
    }

    .stat-card.danger .stat-icon {
      background: #fee2e2;
      color: var(--accent-danger);
    }

    .stat-card.info .stat-icon {
      background: #e0f2fe;
      color: var(--accent-info);
    }

    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: 4px;
    }

    .stat-card .stat-label {
      font-size: 13px;
      color: var(--neutral-500);
      font-weight: 500;
    }

    /* Scanner Status Card */
    .scanner-status-widget {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--neutral-100);
      margin-bottom: 32px;
    }

    .scanner-status-widget .widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .scanner-status-widget .widget-header h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-800);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .scanner-status-widget .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .scanner-status-widget .status-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--neutral-50);
      border-radius: var(--radius-md);
    }

    .scanner-status-widget .status-item .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .scanner-status-widget .status-item .status-dot.online {
      background: var(--accent-success);
    }

    .scanner-status-widget .status-item .status-dot.offline {
      background: var(--accent-danger);
    }

    .scanner-status-widget .status-item .status-dot.warning {
      background: var(--accent-warning);
    }

    .scanner-status-widget .status-item .status-info {
      flex: 1;
    }

    .scanner-status-widget .status-item .status-label {
      font-size: 12px;
      color: var(--neutral-500);
    }

    .scanner-status-widget .status-item .status-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--neutral-800);
    }

    /* Chart Container */
    .chart-container {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--neutral-100);
    }

    .chart-container h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-800);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Logout Button */
    .logout-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      color: white;
      padding: 14px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <img src="assets/Dohinob logo.png" alt="Logo" class="logo" onerror="this.style.display='none'" />
      <ul class="menu">
        <li><a href="dashboard.html" class="active"><i class="fa-solid fa-home"></i> Dashboard</a></li>
        <li><a href="list.html"><i class="fa-solid fa-users"></i> User List</a></li>
        <li><a href="records.html"><i class="fa-solid fa-clipboard-list"></i> Records</a></li>
        <li><a href="report.html"><i class="fa-solid fa-chart-bar"></i> Reports</a></li>
        <li><a href="scanner-utility.html"><i class="fa-solid fa-fingerprint"></i> Scanner Utility</a></li>
      </ul>
      <button id="logoutBtn" class="logout-btn">
        <i class="fa-solid fa-right-from-bracket"></i>
        Logout
      </button>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="greeting">
          <h2>Welcome, <span id="userName">Admin</span>!</h2>
          <p>Here's your attendance overview for today</p>
        </div>
        <div class="date-badge">
          <i class="fa-solid fa-calendar-day"></i>
          <span id="currentDate">Loading...</span>
        </div>
      </div>

      <!-- Scanner Status Widget -->
      <div class="scanner-status-widget">
        <div class="widget-header">
          <h3>
            <i class="fa-solid fa-fingerprint"></i>
            Scanner Status
          </h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline" id="initSdkBtn" style="padding: 8px 16px; font-size: 12px;">
              <i class="fa-solid fa-plug"></i> Init SDK
            </button>
            <button class="btn btn-outline" id="refreshScannerBtn" style="padding: 8px 16px; font-size: 12px;">
              <i class="fa-solid fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="status-grid">
          <div class="status-item">
            <span class="status-dot" id="apiStatusDot"></span>
            <div class="status-info">
              <div class="status-label">API Service</div>
              <div class="status-value" id="apiStatusValue">Checking...</div>
            </div>
          </div>
          <div class="status-item">
            <span class="status-dot" id="dbStatusDot"></span>
            <div class="status-info">
              <div class="status-label">Database</div>
              <div class="status-value" id="dbStatusValue">Checking...</div>
            </div>
          </div>
          <div class="status-item">
            <span class="status-dot" id="sdkStatusDot"></span>
            <div class="status-info">
              <div class="status-label">SDK Initialized</div>
              <div class="status-value" id="sdkStatusValue">Checking...</div>
            </div>
          </div>
          <div class="status-item">
            <span class="status-dot" id="scannerStatusDot"></span>
            <div class="status-info">
              <div class="status-label">Scanner Device</div>
              <div class="status-value" id="scannerStatusValue">Checking...</div>
            </div>
          </div>
          <div class="status-item">
            <span class="status-dot" id="enrolledStatusDot"></span>
            <div class="status-info">
              <div class="status-label">Enrolled Users</div>
              <div class="status-value" id="enrolledStatusValue">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-icon"><i class="fa-solid fa-user-tie"></i></div>
          <div class="stat-value" id="totalOfficials">0</div>
          <div class="stat-label">Total Officials</div>
        </div>

        <div class="stat-card info">
          <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
          <div class="stat-value" id="totalStaff">0</div>
          <div class="stat-label">Total Staff</div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon"><i class="fa-solid fa-check-circle"></i></div>
          <div class="stat-value" id="ontimeCount">0</div>
          <div class="stat-label">On Time</div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon"><i class="fa-solid fa-clock"></i></div>
          <div class="stat-value" id="lateCount">0</div>
          <div class="stat-label">Late</div>
        </div>

        <div class="stat-card danger">
          <div class="stat-icon"><i class="fa-solid fa-arrow-down"></i></div>
          <div class="stat-value" id="undertimeCount">0</div>
          <div class="stat-label">Undertime</div>
        </div>

        <div class="stat-card primary">
          <div class="stat-icon"><i class="fa-solid fa-arrow-up"></i></div>
          <div class="stat-value" id="overtimeCount">0</div>
          <div class="stat-label">Overtime</div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon"><i class="fa-solid fa-fingerprint"></i></div>
          <div class="stat-value" id="enrolledUsersCount">0</div>
          <div class="stat-label">Enrolled Users</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-container">
        <h3><i class="fa-solid fa-chart-pie"></i> Attendance Overview</h3>
        <canvas id="attendanceChart"></canvas>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="js/api-config.js"></script>
  <script src="js/scanner-service.js"></script>
  <script src="js/dashboard.js"></script>
  <script src="js/authGuard.js"></script>
  <script src="js/logout.js"></script>

  <script>
    // Set current date
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Get username from localStorage
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.username) {
      document.getElementById('userName').textContent = user.username;
    }

    // Scanner status check
    async function checkScannerStatus() {
      const apiDot = document.getElementById('apiStatusDot');
      const apiValue = document.getElementById('apiStatusValue');
      const dbDot = document.getElementById('dbStatusDot');
      const dbValue = document.getElementById('dbStatusValue');
      const sdkDot = document.getElementById('sdkStatusDot');
      const sdkValue = document.getElementById('sdkStatusValue');
      const scannerDot = document.getElementById('scannerStatusDot');
      const scannerValue = document.getElementById('scannerStatusValue');
      const enrolledDot = document.getElementById('enrolledStatusDot');
      const enrolledValue = document.getElementById('enrolledStatusValue');

      let apiOnline = false;

      try {
        // Check API with longer timeout - use correct status endpoint
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        const healthResponse = await fetch(`${API_BASE_URL}/scanner/status`, {
          signal: controller.signal,
          method: 'GET'
        });
        clearTimeout(timeoutId);
        
        const healthData = await healthResponse.json();
        apiOnline = true;

        // API Status
        apiDot.className = 'status-dot online';
        apiValue.textContent = 'Online';

        // SDK Status
        if (healthData.sdk?.initialized) {
          sdkDot.className = 'status-dot online';
          sdkValue.textContent = 'Yes';
        } else {
          sdkDot.className = 'status-dot warning';
          sdkValue.textContent = 'Not initialized';
        }

        // Scanner Status - Check if device is available (USB inserted)
        if (healthData.devices?.connected) {
          scannerDot.className = 'status-dot online';
          scannerValue.textContent = 'Available';
        } else {
          scannerDot.className = 'status-dot warning';
          scannerValue.textContent = 'Not available';
        }

      } catch (error) {
        // API is offline - show error state
        apiDot.className = 'status-dot offline';
        apiValue.textContent = 'Offline';
        dbDot.className = 'status-dot offline';
        dbValue.textContent = 'Offline';
        sdkDot.className = 'status-dot offline';
        sdkValue.textContent = 'Unavailable';
        scannerDot.className = 'status-dot offline';
        scannerValue.textContent = 'Unavailable';
      }

      // Check Database only if API is online
      if (apiOnline) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 8000);
          
          const usersResponse = await fetch(`${API_BASE_URL}/users`, {
            signal: controller.signal,
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          clearTimeout(timeoutId);
          
          if (usersResponse.ok || usersResponse.status === 401) {
            dbDot.className = 'status-dot online';
            dbValue.textContent = 'Online';
          } else {
            throw new Error('Database unavailable');
          }
        } catch (error) {
          dbDot.className = 'status-dot offline';
          dbValue.textContent = 'Offline';
        }
      }

      // Get enrolled count and update immediately
      if (apiOnline) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 8000);
          
          const templatesResponse = await fetch(`${API_BASE_URL}/fingerprint/templates`, {
            signal: controller.signal,
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          clearTimeout(timeoutId);
          
          const templates = await templatesResponse.json();
          const count = Array.isArray(templates.templates) ? templates.templates.length : 0;

          if (count > 0) {
            enrolledDot.className = 'status-dot online';
            enrolledValue.textContent = `${count} enrolled`;
          } else {
            enrolledDot.className = 'status-dot warning';
            enrolledValue.textContent = '0 enrolled';
          }
          
          // Update the stat card
          document.getElementById('enrolledUsersCount').textContent = count;
        } catch (error) {
          console.error('Enrolled users fetch error:', error);
          enrolledDot.className = 'status-dot warning';
          enrolledValue.textContent = 'Unable to fetch';
          document.getElementById('enrolledUsersCount').textContent = '0';
        }
      } else {
        enrolledDot.className = 'status-dot offline';
        enrolledValue.textContent = 'Unavailable';
        document.getElementById('enrolledUsersCount').textContent = '0';
      }
    }

    // Initialize SDK button
    document.getElementById('initSdkBtn').addEventListener('click', async function () {
      try {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        const response = await fetch(`${API_BASE_URL}/scanner/initialize`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update SDK status immediately
          document.getElementById('sdkStatusDot').className = 'status-dot online';
          document.getElementById('sdkStatusValue').textContent = 'Yes';
          Swal.fire('Success', 'SDK Initialized Successfully', 'success');
          // Refresh all statuses
          await checkScannerStatus();
        } else {
          Swal.fire('Error', data.message || 'Failed to initialize SDK', 'error');
        }
        
        icon.classList.remove('fa-spin');
      } catch (err) {
        console.error('SDK init error:', err);
        Swal.fire('Error', 'Failed to initialize SDK: ' + err.message, 'error');
        const icon = this.querySelector('i');
        icon.classList.remove('fa-spin');
      }
    });

    // Refresh Scanner Status button
    document.getElementById('refreshScannerBtn').addEventListener('click', async function () {
      try {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        // Show loading state for all status items
        document.getElementById('apiStatusDot').className = 'status-dot';
        document.getElementById('apiStatusValue').textContent = 'Checking...';
        document.getElementById('dbStatusDot').className = 'status-dot';
        document.getElementById('dbStatusValue').textContent = 'Checking...';
        document.getElementById('sdkStatusDot').className = 'status-dot';
        document.getElementById('sdkStatusValue').textContent = 'Checking...';
        document.getElementById('scannerStatusDot').className = 'status-dot';
        document.getElementById('scannerStatusValue').textContent = 'Checking...';
        
        // Run status check
        await checkScannerStatus();
        
        // Keep spinning briefly to show work was done
        await new Promise(resolve => setTimeout(resolve, 500));
        icon.classList.remove('fa-spin');
      } catch (err) {
        console.error('Refresh error:', err);
        const icon = this.querySelector('i');
        icon.classList.remove('fa-spin');
      }
    });

    // Initial check on page load
    document.addEventListener('DOMContentLoaded', () => {
      checkScannerStatus();
      // Check every 30 seconds
      setInterval(checkScannerStatus, 30000);
    });

    // Call initial check immediately
    checkScannerStatus();
  </script>
</body>

</html>